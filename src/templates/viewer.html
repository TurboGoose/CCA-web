{# templates/viewer.html #}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>CSV viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
            crossorigin="anonymous"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/mainpage.js') }}" defer></script>
</head>

<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-3">
    <div class="container d-flex justify-content-between">
        <a href="/" class="navbar-brand me-5">Annotator</a>
        <div class="container col-6">
            <form id="searchForm" class="d-flex justify-content-center" role="search">
                <input id="searchInput" class="form-control me-2" type="search" placeholder="Search"
                        {% if query %} value="{{ query }}" {% endif %}>
                <button type="submit" class="btn btn-outline-success">Search</button>
            </form>
        </div>
    </div>
</nav>

<div class="container d-flex justify-content-between p-0">
    <div class="d-flex justify-content-start flex-grow-1">
        <div class="form-floating col-4">
            <select id="chooseDatasetSelect" class="form-select">
                <option id="defaultOptionDataset" selected disabled value="default">
                    {% if current_dataset %}
                        {{ current_dataset }}
                    {% else %}
                        Choose dataset
                    {% endif %}
                </option>
                {% for dataset in other_datasets %}
                    <option value="{{ dataset }}">{{ dataset }}</option>
                {% endfor %}
            </select>
            <label for="chooseDatasetSelect">Current dataset</label>
        </div>
        <button type="button" class="btn btn-primary ms-2" data-bs-toggle="modal"
                data-bs-target="#uploadFileModal">
            Upload dataset
        </button>
    </div>

    {% if current_dataset %}
        <div class="d-flex justify-content-center">
            <button id="assignLabelButton" type="button" class="btn btn-primary">
                Assign label
            </button>
            <div class="dropdown">
                <button type="button" class="btn btn-primary dropdown-toggle ms-2" data-bs-toggle="dropdown">
                    Download
                    {#                    Download <img src="{{ url_for('static', filename="img/download.svg") }}" alt="download"/>#}
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#">csv</a></li>
                    <li><a class="dropdown-item" href="#">json</a></li>
                </ul>
            </div>

        </div>

        <div class="d-flex justify-content-end flex-grow-1">
            <div class="form-floating col-4">
                <select id="chooseLabelSelect" class="form-select">
                    {% for label in labels %}
                        <option value="{{ label }}">{{ label }}</option>
                    {% endfor %}
                </select>
                <label for="chooseLabelSelect">Current label</label>
            </div>

            <script>
                function getCurrentDataset() {
                    const url = new URL(window.location.href);
                    return url.searchParams.get("dataset");
                }

                const DEFAULT_LABEL_PLACEHOLDER = 'Choose label';
                let labelSelect = document.getElementById('chooseLabelSelect');

                function setDefaultLabel() {
                    if (labelSelect.options.length === 0) {
                        console.log()
                        let placeholderOption = document.createElement('option');
                        placeholderOption.textContent = DEFAULT_LABEL_PLACEHOLDER;
                        placeholderOption.value = 'default';
                        labelSelect.appendChild(placeholderOption);
                    }
                    const firstOpt = labelSelect.options[0];
                    firstOpt.selected = true;
                    firstOpt.disabled = true;
                    return firstOpt.text;
                }

                let currentLabel = setDefaultLabel();

                // change label
                document.getElementById('chooseLabelSelect').addEventListener("change", event => {
                    selectOption('chooseLabelSelect', event.target.value);
                });

                function selectOption(selectId, optionValue) {
                    currentLabel = optionValue;
                    const selectElement = document.getElementById(selectId);
                    const options = selectElement.options;

                    for (let i = 0; i < options.length; i++) {
                        if (options[i].disabled) {
                            if (options[i].text === DEFAULT_LABEL_PLACEHOLDER) {
                                labelSelect.remove(i);
                            } else {
                                options[i].disabled = false;
                            }
                            break;
                        }
                    }

                    for (let j = 0; j < options.length; j++) {
                        if (options[j].value === optionValue) {
                            options[j].disabled = true;
                            break;
                        }
                    }
                }

                // assign label
                document.getElementById('assignLabelButton').addEventListener("click", event => {
                    if (!getCurrentDataset() || currentLabel === DEFAULT_LABEL_PLACEHOLDER) {
                        return
                    }
                    const checkedBoxes = document.querySelectorAll('input[id^="checkbox-"]:checked');
                    const ids = [];
                    checkedBoxes.forEach(element => {
                        element.checked = false;
                        const checkboxId = element.id;
                        const parts = checkboxId.split('-');
                        const id = parts[1];
                        ids.push(parseInt(id, 10));
                    });

                    const body = {"label": currentLabel, "dataset": getCurrentDataset(), "ids": ids};
                    const url = new URL(window.location.href.split("?")[0]);
                    url.pathname = "/mark";

                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(body)
                    });

                    ids.forEach(id => {
                        const label = document.querySelector(`td[id^="label-${id}"]`);
                        label.innerText = currentLabel;
                    })
                });
            </script>

            <button type="button" class="btn btn-primary ms-2" data-bs-toggle="modal"
                    data-bs-target="#addNewLabelModal">
                Add label
            </button>
        </div>
    {% endif %}
</div>

<!-- Add new label modal -->
<div class="modal fade" id="addNewLabelModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5">Add new label</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form action="{{ url_for('add_new_label') }}" method="POST" id="addNewLabelForm">
                    <input type="hidden" name="dataset" value="{{ current_dataset }}">
                    <input type="text" name="label" class="form-control" placeholder="Label name" required>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button class="btn btn-primary" form="addNewLabelForm">Add</button>
            </div>
        </div>
    </div>
</div>

<!-- Upload file modal -->
<div class="modal fade" id="uploadFileModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5">Upload file</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form action="{{ url_for('upload_file') }}" method="POST" id="fileUploadForm"
                      enctype="multipart/form-data">
                    <input type="file" name="file" class="form-control" required>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button class="btn btn-primary" form="fileUploadForm">Upload</button>
            </div>
        </div>
    </div>
</div>

<div class="container mt-3 p-0">
    {% if data is not none %}
        <div class="container" style="padding-right: 27px;">
            <table class="table table-bordered mb-0">
                <thead class="table mb-0 table-dark">
                <tr class="row">
                    <th class="col-auto"><input style="opacity:0;" type="checkbox" disabled/></th>
                    <th class="col-1">Label</th>
                    <th class="col-1">ID</th>
                    <th class="col-2">Username</th>
                    <th class="col-2">Sent</th>
                    <th class="col">Text</th>
                </tr>
                </thead>
            </table>
        </div>

        <div class="container overflow-auto" style="height: 70vh">
            <table class="table table-striped table-bordered">
                <tbody>
                {% for index, row in data.iterrows() %}
                    <tr class="row">
                        <td class="col-auto"><input type="checkbox" id="checkbox-{{ index }}"/></td>
                        <td id="label-{{ index }}" class="col-1" style="word-break: break-word">
                            {{ row["label"] if row["label"] is not none else "-" }}
                        </td>
                        <td class="col-1" style="word-break: break-word">{{ index }}</td>
                        <td class="col-2" style="word-break: break-word">{{ row["username"] }}</td>
                        <td class="col-2" style="word-break: break-word">{{ row["sent"] }}</td>
                        <td class="col" style="word-break: break-word">{{ row["text"]|safe }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

    {% else %}
        <h2 class="text-center">No dataset selected</h2>
    {% endif %}

</div>
</body>
</html>